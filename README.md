# Ppopgi (ë½‘ê¸°) â€” Indexer (The Graph)

This repository contains the **Ppopgi indexer**, built with **The Graph**, targeting **Etherlink (EVM)**.

The indexer exists to make the Ppopgi frontend:
- fast
- transparent
- easy to browse
- safe for users

It is intentionally designed as a **read-optimization layer**, **not** a source of truth.

> **On-chain state always wins.**  
> The indexer improves UX, never authority.

---

## ğŸŒ± Why This Indexer Exists

Ppopgi is a lottery-style application with:
- many independent raffle contracts
- long-lived historical data
- global sorting needs (prize size, expiry, ticket price)

Reading everything directly from RPC would be:
- slow
- expensive
- difficult to paginate and sort

The indexer solves this by:
- indexing lifecycle events
- exposing fast, queryable raffle metadata
- preserving full transparency

---

## ğŸ§  Core Design Principle: Hybrid Truth Model

The system follows a **hybrid model**:

### âœ… What the indexer is used for
- Listing raffles
- Sorting & filtering
- Browsing past raffles
- Showing winners for completed raffles
- Fast initial page loads

### âŒ What the indexer is NOT used for
- User balances
- Claim eligibility
- Refund eligibility
- Finalization readiness
- Anything the user is about to sign a transaction for

**Any action-critical data is always read directly from the blockchain.**

---

## ğŸ“¦ Indexed Contracts

### 1ï¸âƒ£ LotteryRegistry
Canonical source of valid raffles.

Indexed events:
- `LotteryRegistered(index, typeId, lottery, creator)`

Used for:
- discovery
- anti-spam guarantees
- creator attribution

---

### 2ï¸âƒ£ SingleWinnerDeployer
Factory contract used to create raffles.

Indexed events:
- `LotteryDeployed(...)`
- `ConfigUpdated(...)`

Used for:
- creation metadata
- default protocol configuration
- Create-page transparency

---

### 3ï¸âƒ£ LotterySingleWinner (dynamic data sources)
Each deployed raffle is indexed individually.

Indexed lifecycle events:
- `LotteryFinalized`
- `WinnerPicked`
- `LotteryCanceled`

Optional analytics-only events:
- `TicketsPurchased` (never authoritative)

---

## ğŸ—‚ï¸ Data Model (High-Level)

### Entity: `Raffle`

Represents one `LotterySingleWinner` contract.

Includes:
- immutable metadata (name, creator, ticket price, pot)
- lifecycle state (open, drawing, completed, canceled)
- outcome data (winner, winning ticket)
- transparency data (fees, entropy provider)

The indexer **never** tracks:
- per-user balances
- ticket ownership
- claimable funds

---

## ğŸš¦ Explicitly Non-Indexed Data

The following **must always be read on-chain**:

- `ticketsOwned(user)`
- `claimableFunds(user)`
- `claimableNative(user)`
- allowance / approval state
- finalize eligibility
- pause state
- refund eligibility

This prevents:
- stale UI
- incorrect user actions
- trust erosion

---

## ğŸ” Indexing Strategy

### Raffle creation
- Listen to `SingleWinnerDeployer.LotteryDeployed`
- Create a dynamic data source for the raffle

### Registry confirmation
- Listen to `LotteryRegistry.LotteryRegistered`
- Mark raffle as canonical

### Lifecycle tracking
- Update status from events:
  - Open â†’ Drawing â†’ Completed / Canceled

### Factory configuration
- Track `ConfigUpdated` for Create-page display only

---

## ğŸ§© Frontend Integration Rules

### List pages
- Subgraph-first
- No per-card RPC calls
- Optional freshness indicator

### Raffle details page
- Subgraph for fast initial render
- RPC reads for confirmation
- On-chain data always overrides indexer data

### User-specific data
- RPC only
- Never indexer-backed

---

## â³ Indexer Lag & Reorg Safety

- The Graph is eventually consistent
- Reorgs may briefly surface stale data
- UX must tolerate temporary inconsistencies

**User actions must never depend on indexer state alone.**

---

## ğŸ›¡ï¸ Security & Trust Model

The indexer is **not part of the security boundary**.

Indexer bugs:
- cannot steal funds
- cannot block withdrawals
- cannot cause incorrect settlements

All safety guarantees are enforced:
- on-chain
- by contract invariants
- by Foundry tests

---

## ğŸ“ Repository Structure

```text
ppopgi-indexer/
â”œâ”€â”€ README.md
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ schema.graphql
â”œâ”€â”€ subgraph.yaml
â”œâ”€â”€ abis/
â”‚   â”œâ”€â”€ LotteryRegistry.json
â”‚   â”œâ”€â”€ SingleWinnerDeployer.json
â”‚   â””â”€â”€ LotterySingleWinner.json
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ _helpers.ts
â”‚   â”œâ”€â”€ registry.ts
â”‚   â”œâ”€â”€ factory.ts
â”‚   â””â”€â”€ raffle.ts
â”œâ”€â”€ generated/
â”‚   â””â”€â”€ (auto-generated by graph codegen)
â”œâ”€â”€ deployments/
â”‚   â””â”€â”€ etherlink-mainnet.json
â””â”€â”€ .github/
    â””â”€â”€ workflows/
        â””â”€â”€ check.yml